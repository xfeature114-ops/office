Sub ExtractRFQTables_Summary_WithCharts()

    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim outSheet As Worksheet
    Dim sectionHeaders As Variant
    sectionHeaders = Array("Opportunity Discussion", "Organise", "Scrub BOM", "KOM", "CBOM", _
                           "Quote preparation", "Quote review & submission", "Negotiation", "CBOM Re-work")

    ' Create or clear "Extracted Summary" sheet
    On Error Resume Next
    Set outSheet = ThisWorkbook.Sheets("Extracted Summary")
    If outSheet Is Nothing Then
        Set outSheet = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
        outSheet.Name = "Extracted Summary"
    Else
        outSheet.Cells.Clear
        ' Delete existing charts
        Dim c As ChartObject
        For Each c In outSheet.ChartObjects
            c.Delete
        Next c
    End If
    On Error GoTo 0

    ' Find required column positions from row 2
    Dim colSynced As Long, colOppName As Long, colRFQ As Long, i As Long
    For i = 1 To ws.Cells(2, ws.Columns.Count).End(xlToLeft).Column
        Select Case LCase(Trim(ws.Cells(2, i).Text))
            Case "synced quote": colSynced = i
            Case "opportunity name": colOppName = i
            Case "rfq received date": colRFQ = i
        End Select
    Next i
    If colSynced = 0 Or colOppName = 0 Or colRFQ = 0 Then
        MsgBox "? Missing header(s): Synced Quote, Opportunity Name or RFQ Received Date!", vbCritical
        Exit Sub
    End If

    Dim outRow As Long: outRow = 1
    Dim lastRow As Long: lastRow = ws.Cells(ws.Rows.Count, 2).End(xlUp).Row
    Dim section As Variant, sectionStart As Long, sectionEnd As Long
    Dim j As Long, aging As Variant
    Dim maxAging() As Variant: ReDim maxAging(0 To UBound(sectionHeaders))
    Dim sumAging() As Double: ReDim sumAging(0 To UBound(sectionHeaders))
    Dim countAging() As Long: ReDim countAging(0 To UBound(sectionHeaders))

    Dim tempData As Collection
    Dim rowData As Variant
    Dim r As Long
    Dim chartCount As Long: chartCount = 0

    For i = 0 To UBound(sectionHeaders)
        section = sectionHeaders(i)
        sectionStart = 0: sectionEnd = 0

        ' Locate section start (case-insensitive)
        For j = 1 To lastRow
            If LCase(Trim(ws.Cells(j, 2).Value)) = LCase(Trim(section)) Then
                sectionStart = j
                Exit For
            End If
        Next j
        If sectionStart = 0 Then GoTo NextSection

        ' Locate section end
        For j = sectionStart + 1 To lastRow
            If LCase(Trim(ws.Cells(j, 2).Value)) = "subtotal" Then
                sectionEnd = j - 1
                Exit For
            End If
        Next j
        If sectionEnd = 0 Then sectionEnd = lastRow

        Set tempData = New Collection
        maxAging(i) = 0
        sumAging(i) = 0
        countAging(i) = 0

        ' Collect all rows regardless of RFQ date validity
        For j = sectionStart + 1 To sectionEnd
            If Application.CountA(ws.Rows(j)) = 0 Then GoTo SkipRow

            Dim rfqDateVal As Variant
            rfqDateVal = ws.Cells(j, colRFQ).Value

            Dim agingVal As Variant
            If IsDate(rfqDateVal) Then
                agingVal = Date - CDate(rfqDateVal)
            Else
                agingVal = ""   ' Could be blank or "N/A"
            End If

            rowData = Array(ws.Cells(j, colSynced).Value, ws.Cells(j, colOppName).Value, rfqDateVal, agingVal)
            tempData.Add rowData

            If IsDate(rfqDateVal) Then
                If agingVal > maxAging(i) Then maxAging(i) = agingVal
                sumAging(i) = sumAging(i) + agingVal
                countAging(i) = countAging(i) + 1
            End If
SkipRow:
        Next j

        ' Output section header regardless of data
        With outSheet.Cells(outRow, 1)
            .Value = section
            .Font.Bold = True
            .Font.Size = 12
            .Font.Name = "Century Gothic"
        End With
        outRow = outRow + 1

        ' Output table header regardless of data presence
        With outSheet.Range(outSheet.Cells(outRow, 1), outSheet.Cells(outRow, 4))
            .Value = Array("Synced Quote", "Opportunity Name", "RFQ Received Date", "Aging (days)")
            .Font.Bold = True
            .Interior.Color = RGB(200, 200, 200)
            .Font.Name = "Century Gothic"
        End With

        Dim tableStartRow As Long: tableStartRow = outRow
        outRow = outRow + 1

        ' Output data or "No data" row
        If tempData.Count > 0 Then
            For r = 1 To tempData.Count
                rowData = tempData(r)
                With outSheet.Cells(outRow, 1).Resize(1, 4)
                    .Value = rowData
                    .Font.Name = "Century Gothic"
                    ' Format RFQ Received Date as date if valid
                    If IsDate(rowData(2)) Then
                        .Cells(1, 3).NumberFormat = "dd-mmm-yyyy"
                    Else
                        .Cells(1, 3).NumberFormat = "General"
                    End If
                End With
                outRow = outRow + 1
            Next r
        Else
            outSheet.Cells(outRow, 1).Value = "No data"
            outSheet.Cells(outRow, 1).Font.Italic = True
            outSheet.Cells(outRow, 1).Font.Name = "Century Gothic"
            outRow = outRow + 1
        End If

        ' Apply borders
        With outSheet.Range(outSheet.Cells(tableStartRow, 1), outSheet.Cells(outRow - 1, 4)).Borders
            .LineStyle = xlContinuous
            .Weight = xlThin
        End With

        ' Add chart only if data exists
        If tempData.Count > 0 Then
            chartCount = chartCount + 1
            Dim chObj As ChartObject
            Set chObj = outSheet.ChartObjects.Add(Left:=500, Width:=350, _
                                                  Top:=outSheet.Cells(tableStartRow, 6).Top, Height:=150)
            chObj.Chart.ChartType = xlColumnClustered
            chObj.Chart.SetSourceData Source:=outSheet.Range(outSheet.Cells(tableStartRow + 1, 4), outSheet.Cells(outRow - 1, 4))
            chObj.Chart.SeriesCollection(1).XValues = outSheet.Range(outSheet.Cells(tableStartRow + 1, 1), outSheet.Cells(outRow - 1, 1))
            chObj.Chart.HasTitle = True
            chObj.Chart.ChartTitle.Text = section & " - RFQ Aging"
            chObj.Chart.Axes(xlCategory).HasTitle = True
            chObj.Chart.Axes(xlCategory).AxisTitle.Text = "Synced Quote"
            chObj.Chart.Axes(xlValue).HasTitle = True
            chObj.Chart.Axes(xlValue).AxisTitle.Text = "Aging (days)"
            chObj.Name = "Chart_" & chartCount
            chObj.Chart.SeriesCollection(1).ApplyDataLabels Type:=xlDataLabelsShowValue
        End If

        outRow = outRow + 2

NextSection:
    Next i

    ' === Summary Table ===
    Dim summaryStartCol As Long: summaryStartCol = 7 ' column G
    Dim summaryStartRow As Long: summaryStartRow = 1

    With outSheet.Cells(summaryStartRow, summaryStartCol)
        .Value = "Summary"
        .Font.Bold = True
        .Font.Name = "Century Gothic"
    End With
    With outSheet.Cells(summaryStartRow, summaryStartCol + 1)
        .Value = "Count of Projects"
        .Font.Bold = True
        .Font.Name = "Century Gothic"
    End With
    outSheet.Range(outSheet.Cells(summaryStartRow, summaryStartCol), outSheet.Cells(summaryStartRow, summaryStartCol + 1)).Interior.Color = RGB(200, 200, 200)

    Dim summaryRow As Long: summaryRow = summaryStartRow + 1
    For i = 0 To UBound(sectionHeaders)
        With outSheet.Cells(summaryRow, summaryStartCol)
            .Value = sectionHeaders(i)
            .Font.Name = "Century Gothic"
        End With
        With outSheet.Cells(summaryRow, summaryStartCol + 1)
            .Value = countAging(i)  ' count, zero if no data
            .Font.Name = "Century Gothic"
        End With
        summaryRow = summaryRow + 1
    Next i

    With outSheet.Range(outSheet.Cells(summaryStartRow, summaryStartCol), outSheet.Cells(summaryRow - 1, summaryStartCol + 1)).Borders
        .LineStyle = xlContinuous
        .Weight = xlThin
    End With

    MsgBox "? Done! Tables + charts saved to 'Extracted Summary'", vbInformation

End Sub



